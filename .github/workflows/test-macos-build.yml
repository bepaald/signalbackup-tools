name: Test macOs build

on:
  workflow_dispatch:
  push:
    tags-ignore:
      - '[0-9]*'
    branches:
      - master
    paths-ignore:
      - '**/README.md'
      - '**/ERRATA.md'
      - '**/autoversion.h'
      - '.github/workflows/*.yml'

# This allows a subsequently queued workflow run to interrupt previous runs
concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  do-build-tests:
    runs-on: macos-latest
    steps:
      - name: Prepare
        run: |
          brew update
          # I've been (intermittently) getting this error:
          # Error: cmake is already installed from local/pinned!
          # Please `brew uninstall cmake` first."
          # so lets try that
          brew uninstall cmake

      - name: Build
        run: |
          echo "Tapping..."
          brew tap bepaald/signalbackup-tools https://github.com/bepaald/signalbackup-tools
          echo "Installing..."
          brew install --HEAD signalbackup-tools
          echo "Testing..."
          brew test signalbackup-tools
          echo "done!"
